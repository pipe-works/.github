# Reusable Python CI Workflow for pipe-works organization
# Based on pipeworks_name_generation's comprehensive CI setup
#
# Usage in your repo's .github/workflows/ci.yml:
#
# Standard Python project:
# jobs:
#   ci:
#     uses: pipe-works/.github/.github/workflows/reusable-python-ci.yml@main
#     with:
#       python-version: '3.12'
#       coverage-threshold: 50
#       run-security: true
#       run-docs: true
#     secrets: inherit
#
# ML/Model project (requires disk cleanup and test markers):
# jobs:
#   ci:
#     uses: pipe-works/.github/.github/workflows/reusable-python-ci.yml@main
#     with:
#       python-version: '3.12'
#       coverage-threshold: 50
#       requires-models: true
#       pytest-markers: 'not requires_model and not slow'
#     secrets: inherit

name: Reusable Python CI

on:
  workflow_call:
    inputs:
      python-version:
        description: 'Python version to use'
        required: false
        type: string
        default: '3.12'
      additional-python-versions:
        description: 'Additional Python versions to test (JSON array, e.g. ["3.13"])'
        required: false
        type: string
        default: '[]'
      coverage-threshold:
        description: 'Minimum coverage percentage'
        required: false
        type: number
        default: 50
      run-security:
        description: 'Run security scans (bandit, trivy)'
        required: false
        type: boolean
        default: true
      run-docs:
        description: 'Build and validate documentation'
        required: false
        type: boolean
        default: false
      test-os:
        description: 'Operating systems to test on (JSON array, e.g. ["ubuntu-latest", "macos-latest"])'
        required: false
        type: string
        default: '["ubuntu-latest"]'
      requires-models:
        description: 'Enable ML model testing support (disk cleanup, offline mode, custom markers)'
        required: false
        type: boolean
        default: false
      pytest-markers:
        description: 'Pytest marker expression (e.g. "not requires_model and not slow")'
        required: false
        type: string
        default: ''
      pytest-args:
        description: 'Additional pytest arguments (appended to default args)'
        required: false
        type: string
        default: ''
    secrets:
      CODECOV_TOKEN:
        required: true

jobs:
  # Code quality checks (linting, formatting, type checking)
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ inputs.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ inputs.python-version }}
        cache: pip

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Run Ruff linting
      run: |
        ruff check .

    - name: Check code formatting with Black
      run: |
        black --check --diff .

    - name: Run mypy type checking
      run: |
        mypy src/ || true
      continue-on-error: true

  # Test suite with coverage
  test:
    name: Test Python ${{ matrix.python-version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: ${{ fromJSON(inputs.test-os) }}
        python-version: ${{ fromJSON(format('["{0}"{1}]', inputs.python-version, inputs.additional-python-versions != '[]' && format(', {0}', inputs.additional-python-versions) || '')) }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: pip

    - name: Free up disk space (ML models)
      if: ${{ inputs.requires-models }}
      run: |
        # Remove unnecessary software to free up ~10GB for ML model testing
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/share/boost
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
        df -h

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # Use --no-cache-dir for ML projects to save disk space
        if [ "${{ inputs.requires-models }}" == "true" ]; then
          pip install --no-cache-dir -e ".[dev]"
        else
          pip install -e ".[dev]"
        fi

    - name: Run tests with pytest
      run: |
        # Build pytest command with optional markers and args
        PYTEST_CMD="pytest -v --cov --cov-report=xml --cov-report=term --cov-fail-under=${{ inputs.coverage-threshold }}"

        # Add marker expression if provided
        if [ -n "${{ inputs.pytest-markers }}" ]; then
          PYTEST_CMD="$PYTEST_CMD -m '${{ inputs.pytest-markers }}'"
        fi

        # Add additional args if provided
        if [ -n "${{ inputs.pytest-args }}" ]; then
          PYTEST_CMD="$PYTEST_CMD ${{ inputs.pytest-args }}"
        fi

        eval $PYTEST_CMD
      env:
        # Prevent accidental model downloads in ML projects
        PIPEWORKS_MODELS_DIR: ${{ inputs.requires-models && '/tmp/models' || '' }}
        HF_HUB_OFFLINE: ${{ inputs.requires-models && '1' || '0' }}

    - name: Upload coverage to Codecov
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == inputs.python-version
      uses: codecov/codecov-action@v4
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  # Security scanning
  security:
    name: Security Scan
    if: ${{ inputs.run-security }}
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ inputs.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ inputs.python-version }}
        cache: pip

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install bandit[toml]

    - name: Run Bandit security scan
      run: |
        bandit -r . -c pyproject.toml || true
      continue-on-error: true

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
      continue-on-error: true

    - name: Upload Trivy results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v4
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'
      continue-on-error: true

  # Documentation build (if enabled)
  docs:
    name: Documentation Build
    if: ${{ inputs.run-docs }}
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ inputs.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ inputs.python-version }}
        cache: pip

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[docs]"

    - name: Build documentation
      run: |
        cd docs
        make html

  # Package build validation
  build:
    name: Build Package
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ inputs.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ inputs.python-version }}
        cache: pip

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine

    - name: Build package
      run: |
        python -m build

    - name: Check package with twine
      run: |
        twine check dist/*

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dist-packages-${{ matrix.os || 'ubuntu-latest' }}-py${{ matrix.python-version || inputs.python-version }}
        path: dist/
        retention-days: 7
